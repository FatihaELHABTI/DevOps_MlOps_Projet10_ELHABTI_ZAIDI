name: CI/CD Minimal - Edge AI

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
  pull_request:
    branches:
      - main

jobs:
  basic-checks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      
      - name: Check Python syntax
        run: |
          python -m py_compile $(find . -name "*.py" -not -path "./venv/*" -not -path "./.venv/*" -not -path "./.dvc/*") || echo "No Python files or syntax errors found"
      
      - name: List project structure
        run: |
          echo " Project structure:"
          ls -laR | head -100 || true

  check-dvc:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Check DVC configuration
        run: |
          if [ -d ".dvc" ]; then
            echo " DVC is initialized"
            if [ -f ".dvc/config" ]; then
              cat .dvc/config
            else
              echo " No .dvc/config file"
            fi
          else
            echo " DVC not initialized"
            exit 1
          fi
      
      - name: Check for .dvc files
        run: |
          echo " DVC tracked files:"
          find . -name "*.dvc" -type f || echo "No DVC files found"

  check-models:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Check model references
        run: |
          echo " Checking for model files..."
          
          if [ -f "models/model_int8.tflite.dvc" ]; then
            echo " Int8 model tracked in DVC"
            cat models/model_int8.tflite.dvc
          else
            echo " Int8 model not found"
          fi
          
          if [ -f "models/model_float32.tflite.dvc" ]; then
            echo " Float32 model tracked in DVC"
            cat models/model_float32.tflite.dvc
          else
            echo " Float32 model not found"
          fi

  check-docker:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Check Dockerfiles
        run: |
          echo " Checking for Dockerfiles..."
          
          if [ -f "Dockerfile" ]; then
            echo " Dockerfile found"
            echo "First 20 lines:"
            head -20 Dockerfile
          else
            echo " No Dockerfile found (optional for now)"
          fi
          
          if [ -f "docker-compose.yml" ]; then
            echo " docker-compose.yml found"
          else
            echo " No docker-compose.yml found (optional for now)"
          fi

  check-documentation:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Check README
        run: |
          if [ -f "README.md" ]; then
            echo " README.md exists"
            echo "Lines: $(wc -l < README.md)"
          else
            echo " No README.md found"
          fi
      
      - name: Check for documentation
        run: |
          echo " Documentation files:"
          find . -name "*.md" -o -name "*.pdf" | grep -v node_modules | grep -v venv | grep -v .dvc || echo "Limited documentation found"

  generate-report:
    runs-on: ubuntu-latest
    needs: [basic-checks, check-dvc, check-models, check-docker, check-documentation]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Generate project health report
        run: |
          cat << 'EOF' > project-report.md
          #  Project Health Report
          
          ##  Checks Completed
          - Python syntax validation
          - DVC configuration check
          - Project structure verification
          - Documentation check
          
          ##  Project Statistics
          EOF
          
          echo "- **Python files**: $(find . -name '*.py' -not -path '*/venv/*' -not -path '*/.venv/*' -not -path '*/.dvc/*' | wc -l)" >> project-report.md
          echo "- **Lines of code**: $(find . -name '*.py' -not -path '*/venv/*' -not -path '*/.venv/*' -not -path '*/.dvc/*' -exec cat {} \; 2>/dev/null | wc -l)" >> project-report.md
          echo "- **DVC files**: $(find . -name '*.dvc' -type f | wc -l)" >> project-report.md
          
          echo "" >> project-report.md
          echo "##  Recommendations" >> project-report.md
          echo "- Add unit tests with pytest" >> project-report.md
          echo "- Add integration tests" >> project-report.md
          echo "- Configure DVC remote storage" >> project-report.md
          echo "- Add performance benchmarks" >> project-report.md
          echo "- Document API endpoints" >> project-report.md
          
          cat project-report.md
      
      - name: Upload report
        uses: actions/upload-artifact@v4
        with:
          name: project-report
          path: project-report.md

  security-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Check for hardcoded secrets
        run: |
          echo "üîê Scanning for potential secrets..."
          
          # Check for common secret patterns
          SECRET_FOUND=0
          
          if grep -r "password\s*=\s*['\"][^'\"]\+" . --exclude-dir=venv --exclude-dir=.git --exclude-dir=.dvc 2>/dev/null; then
            echo " Found potential hardcoded password"
            SECRET_FOUND=1
          fi
          
          if grep -r "api[_-]key\s*=\s*['\"][^'\"]\+" . --exclude-dir=venv --exclude-dir=.git --exclude-dir=.dvc 2>/dev/null; then
            echo " Found potential hardcoded API key"
            SECRET_FOUND=1
          fi
          
          if grep -r "secret\s*=\s*['\"][^'\"]\+" . --exclude-dir=venv --exclude-dir=.git --exclude-dir=.dvc 2>/dev/null; then
            echo " Found potential hardcoded secret"
            SECRET_FOUND=1
          fi
          
          if [ $SECRET_FOUND -eq 0 ]; then
            echo " No obvious hardcoded secrets found"
          else
            echo " Please review the findings above (non-blocking)"
          fi
      
      - name: Check for sensitive files
        run: |
          echo " Checking for sensitive files..."
          
          SENSITIVE_FOUND=0
          
          if [ -f ".env" ]; then
            echo " .env file found (should be in .gitignore)"
            SENSITIVE_FOUND=1
          fi
          
          if find . -name "*credentials*.json" -o -name "*creds*.json" | grep -v ".dvc" | grep -q .; then
            echo " Credential files found"
            SENSITIVE_FOUND=1
          fi
          
          if [ $SENSITIVE_FOUND -eq 0 ]; then
            echo " No sensitive files detected"
          fi
      
      - name: Dependency vulnerability check
        continue-on-error: true
        run: |
          if [ -f "requirements.txt" ]; then
            echo " Checking dependencies for vulnerabilities..."
            pip install --upgrade pip
            pip install safety
            safety check -r requirements.txt --output text || echo "‚ö†Ô∏è Some vulnerabilities found (review recommended)"
          else
            echo " No requirements.txt found"
          fi